<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>三視点素数カウントデモ — Hyperplane Arrangement Model</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body {
        font-family: 'Inter', 'Noto Sans JP', sans-serif;
        background-color: #f8fafc; /* Slate-50 */
        color: #1e293b; /* Slate-800 */
        -webkit-tap-highlight-color: transparent;
      }
      h1, h2, h3, .serif {
        font-family: 'Merriweather', 'Noto Sans JP', serif;
      }
      .math-font {
        font-family: 'Times New Roman', Times, serif;
        font-style: italic;
      }
      /* Academic Card Style */
      .academic-card {
        background: white;
        border: 1px solid #e2e8f0;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
      }
      @media (min-width: 768px) {
        .academic-card:hover {
          box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
          border-color: #cbd5e1;
        }
      }
      .animate-fade-in {
        animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef, useCallback } = React;

      // ==========================================
      // [Module] 1. OS Core: Prime Ledger (Finite Database)
      // ==========================================
      const PRIME_PI_LEDGER = Object.freeze([
        { N:  9999,  pi: 1229 },  // π(9999)
        { N: 10500,  pi: 1284 },  // π(10500)
        { N: 49999,  pi: 5133 },  // π(49999)
        { N: 50500,  pi: 5179 },  // π(50500)
        { N: 99999,  pi: 9592 },  // π(99999)
        { N: 100800, pi: 9657 },  // π(100800)
        { N: 10000,  pi: 1229 },  // π(10000)
        { N: 20000,  pi: 2262 },  // π(20000)
        { N: 30000,  pi: 3245 },  // π(30000)
        { N: 40000,  pi: 4203 },  // π(40000)
        { N: 50000,  pi: 5133 },  // π(50000)
      ]);

      const PRIME_PI_INDEX = (() => {
        const m = new Map();
        for (const row of PRIME_PI_LEDGER) {
          m.set(row.N, row.pi);
        }
        return m;
      })();

      function lookupPrimePiFromLedger(N) {
        if (!Number.isInteger(N) || N < 0) return null;
        return PRIME_PI_INDEX.get(N) ?? null;
      }

      function countPrimesExactFromLedger(a, b) {
        if (!Number.isInteger(a) || !Number.isInteger(b)) return null;
        if (a > b) return null;
        if (b < 2) return 0;

        const A = Math.max(2, a);
        const B = b;
        const piB = lookupPrimePiFromLedger(B);
        const piAminus = (A <= 2) ? 0 : lookupPrimePiFromLedger(A - 1);

        if (piB == null || piAminus == null) {
          return null; 
        }
        return piB - piAminus;
      }

      // ==========================================
      // [Module] 2. Math Utilities
      // ==========================================
      function isPrime(n) {
        if (n < 2) return false;
        if (n === 2) return true;
        if (n % 2 === 0) return false;
        const limit = Math.floor(Math.sqrt(n));
        for (let i = 3; i <= limit; i += 2) {
          if (n % i === 0) return false;
        }
        return true;
      }

      function countPrimesNaive(a, b) {
        let count = 0;
        for (let n = a; n <= b; n++) {
          if (isPrime(n)) count++;
        }
        return count;
      }

      function primeApproxPi(x) {
        if (x < 2) return 0;
        if (x <= 100) return countPrimesNaive(2, x); 
        const lx = Math.log(x);
        return x / (lx - 1.08366);
      }

      // ==========================================
      // [Module] 3. OS Logic
      // ==========================================
      function runOsPrediction(a, b) {
        const exact = countPrimesExactFromLedger(a, b);
        const inLedger = (exact !== null);

        const approxA = primeApproxPi(a - 1);
        const approxB = primeApproxPi(b);
        const approxCount = Math.max(0, Math.round(approxB - approxA));

        const width = b - a;
        
        // ★ 誤差設計の修正（太らせる）
        // 旧: sqrt * 1.5 + width * 0.005 -> 新: sqrt * 2.0 + width * 0.02 + 10
        const baseError = Math.sqrt(approxCount || 1) * 2.0; 
        const margin = Math.ceil(baseError + (width * 0.02) + 10);

        return {
          inLedger: inLedger,
          exact: exact,
          approx: approxCount,
          lower: Math.max(0, approxCount - margin),
          upper: approxCount + margin,
          margin: margin
        };
      }

      // ==========================================
      // [Module] 4. Geometry & Safety Models
      // ==========================================
      function assignChamber(a, b) {
        const mid = (a + b) / 2;
        let index = 0;
        const logMid = Math.log10(mid);
        
        if (logMid < 4) index = 0;
        else if (logMid < 5) index = 1;
        else if (logMid < 6) index = 2;
        else index = 3;
        
        if ((b - a) > 2000) index += 1;
        if (index > 5) index = 5;

        const labels = [
          "Type I (Local)", "Type II (Semi-local)", 
          "Type III (Standard)", "Type IV (Extended)",
          "Type V (Asymptotic)", "Type VI (Global)"
        ];
        
        const cellId = `\\mathcal{C}_{${index}}(${Math.floor(mid/100).toString(16).toUpperCase()})`;

        return {
          index,
          label: labels[index],
          cellId,
        };
      }

      function classifySafety(osResult) {
        if (osResult.inLedger) return { level: "safe", message: "安全圏 (Proven)" };
        return { level: "border", message: "推計領域 (Estimated)" };
      }

      // ==========================================
      // [Component] Main App
      // ==========================================
      function App() {
        const MAX_WIDTH_FOR_BRUTE = 50000;
        const MAX_END = 2000000;

        const initialSession = {
          osInLedger: false,
          osExact: null,
          osApprox: null,
          osLower: null,
          osUpper: null,
          chamberLabel: null,
          chamberId: null,
          bruteCount: null,
          progress: 0,
          mode: "idle", // idle | os_geom_ready | os_geom_only | counting | done
          errorMessage: null,
          safetyLevel: "safe",
          range: null,
        };

        const [startInput, setStartInput] = useState("10000");
        const [endInput, setEndInput] = useState("10500");
        const [session, setSession] = useState(initialSession);
        const [showDetails, setShowDetails] = useState(false);
        const timerRef = useRef(null);

        useEffect(() => () => timerRef.current && clearTimeout(timerRef.current), []);

        const startBruteForce = useCallback((A, B) => {
          if (timerRef.current) clearTimeout(timerRef.current);

          let current = A;
          let count = 0;
          const total = B - A + 1;

          const step = () => {
            const CHUNK = 600;
            const endChunk = Math.min(current + CHUNK - 1, B);

            for (let n = current; n <= endChunk; n++) {
              if (isPrime(n)) count++;
            }

            current = endChunk + 1;
            const processed = current - A;
            const progress = Math.min(processed / total, 1);

            setSession((prev) => ({
              ...prev,
              bruteCount: count,
              mode: "counting",
              progress,
            }));

            if (current <= B) {
              timerRef.current = setTimeout(step, 0);
            } else {
              setSession((prev) => ({
                ...prev,
                bruteCount: count,
                mode: "done",
                progress: 1,
              }));
              timerRef.current = null;
            }
          };

          setSession((prev) => ({ ...prev, bruteCount: 0, mode: "counting", progress: 0 }));
          step();
        }, []);

        const handleRun = useCallback(() => {
          const A = parseInt(startInput, 10);
          const B = parseInt(endInput, 10);

          if (Number.isNaN(A) || Number.isNaN(B)) {
            setSession({ ...initialSession, errorMessage: "整数を入力してください。" });
            return;
          }
          if (A < 2 || B <= A) {
            setSession({ ...initialSession, errorMessage: "A ≥ 2 かつ B > A を満たす必要があります。" });
            return;
          }
          if (B > MAX_END) {
             setSession({ ...initialSession, errorMessage: `Bは ${MAX_END.toLocaleString()} 以下に制限されています。` });
            return;
          }

          const width = B - A;
          const osResult = runOsPrediction(A, B);
          const chamber = assignChamber(A, B);
          const safety = classifySafety(osResult);
          const enableBrute = (width <= MAX_WIDTH_FOR_BRUTE);

          setSession({
            ...initialSession,
            osInLedger: osResult.inLedger,
            osExact: osResult.exact,
            osApprox: osResult.approx,
            osLower: osResult.lower,
            osUpper: osResult.upper,
            
            chamberLabel: chamber.label,
            chamberId: chamber.cellId,
            
            bruteCount: null,
            mode: enableBrute ? "os_geom_ready" : "os_geom_only", 
            errorMessage: enableBrute 
              ? null 
              : `区間幅が ${MAX_WIDTH_FOR_BRUTE.toLocaleString()} を超えているため、この区間では OS / 幾何のみ表示し、実測カウンタは自動オフとしています。`,
            safetyLevel: safety.level,
            range: { A, B },
            progress: 0,
          });

          if (enableBrute) {
            startBruteForce(A, B);
          }
        }, [startInput, endInput, startBruteForce]);

        const handleReset = () => {
          if (timerRef.current) clearTimeout(timerRef.current);
          setStartInput("10000");
          setEndInput("10500");
          setSession(initialSession);
        };

        const hasRange = !!session.range;
        const progressPercent = Math.round((session.progress || 0) * 100);
        const rangeWidth = session.range ? session.range.B - session.range.A : null;
        
        let isTripleMatch = false;
        if (session.mode === 'done' && session.bruteCount !== null) {
          if (session.osInLedger) {
            isTripleMatch = (session.osExact === session.bruteCount);
          } else {
            // Ledger外なら「帯の中」に入っていればOK
            isTripleMatch = (session.bruteCount >= session.osLower && session.bruteCount <= session.osUpper);
          }
        }
        
        // Active states & Badges
        const osActive = isTripleMatch ? "border-teal-700 ring-2 ring-teal-700 shadow-md" : "border-gray-200";
        const geomActive = isTripleMatch ? "border-slate-600 ring-2 ring-slate-600 shadow-md" : "border-gray-200";
        const bruteActive = isTripleMatch ? "border-red-800 ring-2 ring-red-800 shadow-md" : "border-gray-200";

        const badgeStyle = session.safetyLevel === 'safe' 
          ? "bg-teal-100 text-teal-800 border-teal-200" 
          : "bg-amber-100 text-amber-800 border-amber-200";
        const badgeText = session.safetyLevel === 'safe' ? "Safe / Proven" : "Border / Estimated";

        const presets = [
          { label: "区間 A (1万〜)", A: 10000, B: 10500 },
          { label: "区間 B (5万〜)", A: 50000, B: 50500 },
          { label: "区間 C (10万〜)", A: 100000, B: 100800 },
        ];
        
        const setPreset = (p) => {
          setStartInput(String(p.A));
          setEndInput(String(p.B));
        };

        // Determine main OS value: Exact if in ledger, Approx if not.
        const mainOsValue = session.osInLedger ? session.osExact : session.osApprox;

        return (
          <div className="min-h-screen pb-24 bg-slate-50">
            {/* Header */}
            <header className="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
              <div className="max-w-2xl mx-auto px-4 py-4 flex flex-col md:flex-row md:items-center justify-between gap-2">
                <div>
                  <h1 className="text-lg md:text-xl font-bold text-slate-900 leading-tight font-serif tracking-tight">
                    三視点素数カウントデモ
                  </h1>
                  <p className="text-[11px] md:text-xs text-slate-500 font-medium mt-1 font-serif text-slate-600">
                    — hyperplane arrangement / 普遍ボアソン変形のトイモデル —
                  </p>
                </div>
                <div className="text-[10px] text-slate-400 font-medium bg-slate-100 px-2 py-1 rounded self-start md:self-center">
                   v1.12 GhostDrift
                </div>
              </div>
            </header>

            <main className="max-w-2xl mx-auto px-4 py-8">
              
              {/* Introduction for Researchers */}
              <section className="mb-8 bg-white p-5 md:p-6 rounded-xl border border-slate-200 shadow-sm">
                <div className="mb-4">
                  <h2 className="text-sm font-bold text-slate-800 mb-2 flex items-center gap-2">
                    <span className="w-1 h-4 bg-slate-800 rounded-full"></span>
                    本デモの数学的背景と目的
                  </h2>
                  <p className="text-xs leading-relaxed text-slate-600 mb-3">
                    このデモは、explicit formula に基づく<strong>「素数個数の有限台帳 (Finite Prime-Count Ledger)」</strong>と、
                    {"$(A,B)$-平面上の"} <strong>Hyperplane Arrangement 型の Chamber 構造</strong>を組み合わせたトイモデルです。
                  </p>
                  <p className="text-xs leading-relaxed text-slate-600 mb-2">
                    {"区間 $[A,B]$ の素数個数 $\\pi(A,B)$ が、有限個のセル (Chamber) と有限台帳によっていかに分類・決定されるかを、"}
                    <strong>OS (Theory) / 幾何 (Geometry) / 実測 (Counter)</strong> の三視点から可視化します。
                  </p>
                  
                  {/* Ledger Note */}
                  <div className="text-[10px] text-slate-500 bg-slate-50 px-3 py-2 rounded border border-slate-100 mt-2">
                    ※ 本デモで使用している <code>{"PRIME_PI_LEDGER"}</code> はデモ用に前計算した有限表であり、本番の ADIC / $\Sigma_1$ 証明書の完全版ではありません。
                  </div>
                </div>

                <div className="grid md:grid-cols-2 gap-4">
                  <div className="bg-slate-50 rounded-lg p-3 border border-slate-100">
                    <h3 className="text-xs font-bold text-teal-800 mb-1">■ 有限台帳と Chamber 分類</h3>
                    <p className="text-[10px] text-slate-600 leading-relaxed">
                      {"超トーリック多様体の普遍ボアソン変形において、$H^2(Y,\\mathbb{C})/W$ 上の Hyperplane Arrangement の Chamber ごとに"}
                      シンプレクティック特異点解消や幾何構造がクラス分けされる構図のアナロジーです。
                    </p>
                  </div>
                  <div className="bg-slate-50 rounded-lg p-3 border border-slate-100">
                    <h3 className="text-xs font-bold text-red-800 mb-1">■ OS (Ledger) vs 実測</h3>
                    <p className="text-[10px] text-slate-600 leading-relaxed">
                      OSは <code>{"PRIME_PI_LEDGER"}</code> と近似モデルのみを参照し、カウンタは独立に <code>{"isPrime"}</code> で実測を行います。Ledger内外で「完全一致」か「推計範囲内か」の検証レベルが変わります。
                    </p>
                  </div>
                </div>
              </section>

              {/* Controls */}
              <section className="bg-white rounded-xl border border-gray-200 shadow-sm p-5 mb-8">
                <div className="mb-6">
                  <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">
                    おすすめ区間 (Presets)
                  </label>
                  <div className="flex flex-wrap gap-2">
                    {presets.map((p) => (
                      <button
                        key={p.label}
                        onClick={() => setPreset(p)}
                        className="flex-1 min-w-[100px] h-10 px-3 rounded-lg border border-slate-200 bg-slate-50 text-xs font-medium text-slate-700 active:bg-slate-200 active:scale-95 transition-all touch-manipulation hover:border-slate-300"
                      >
                        {p.label}
                      </button>
                    ))}
                  </div>
                </div>

                <div className="mb-6">
                  <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">
                    任意の区間指定 <span className="math-font text-slate-600">{"[A, B]"}</span>
                  </label>
                  <p className="text-[10px] text-slate-400 mb-2 leading-snug">
                    制約: A ≥ 2, B &gt; A, <span className="font-semibold text-slate-500">B ≤ {MAX_END.toLocaleString()}</span>。<br/>
                    区間幅 $(B-A) \le {MAX_WIDTH_FOR_BRUTE.toLocaleString()}$ のときのみ実測カウンタが稼働します（それより広い場合はOS/幾何のみ表示）。
                  </p>
                  <div className="flex gap-3 items-center">
                    <input
                      type="number"
                      pattern="\d*"
                      className="w-full h-12 px-3 bg-slate-50 border border-slate-300 rounded-lg font-mono text-base text-center focus:ring-2 focus:ring-slate-400 outline-none transition-all shadow-inner"
                      value={startInput}
                      onChange={(e) => setStartInput(e.target.value)}
                    />
                    <span className="text-slate-400 font-bold">–</span>
                    <input
                      type="number"
                      pattern="\d*"
                      className="w-full h-12 px-3 bg-slate-50 border border-slate-300 rounded-lg font-mono text-base text-center focus:ring-2 focus:ring-slate-400 outline-none transition-all shadow-inner"
                      value={endInput}
                      onChange={(e) => setEndInput(e.target.value)}
                    />
                  </div>
                </div>

                <div className="flex items-center gap-3">
                  <button
                    onClick={handleRun}
                    disabled={session.mode === 'counting'}
                    className="flex-1 h-12 bg-slate-900 text-white text-sm font-bold rounded-lg shadow-md active:bg-slate-800 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed transition-all touch-manipulation flex items-center justify-center hover:bg-slate-800"
                  >
                    {session.mode === 'counting' ? (
                      <span className="flex items-center gap-2">
                        <span className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
                        検証中...
                      </span>
                    ) : '検証を実行 (Run)'}
                  </button>
                  
                  {session.mode !== 'idle' && (
                    <button 
                       onClick={handleReset}
                       className="h-12 w-12 flex items-center justify-center rounded-lg border border-slate-200 bg-white text-slate-500 active:bg-slate-100 active:scale-95 transition-all touch-manipulation hover:bg-slate-50 hover:text-slate-700"
                       title="リセット"
                    >
                      ✕
                    </button>
                  )}
                </div>
                
                {session.errorMessage && (
                  <div className="mt-4 p-3 bg-amber-50 border-l-4 border-amber-500 text-amber-900 text-xs font-medium rounded-r">
                     {session.errorMessage}
                  </div>
                )}
              </section>

              {/* Status Bar */}
              {hasRange && (
                <section className="mb-6 animate-fade-in">
                  <div className="bg-slate-100 border border-slate-200 rounded-lg px-4 py-2 flex flex-wrap justify-between items-center gap-2">
                    <div className="flex items-center gap-2 text-xs text-slate-600">
                      <span className="font-bold text-slate-400 uppercase tracking-wider text-[10px]">Current Range</span>
                      <span className="font-mono bg-white px-2 py-0.5 rounded border border-slate-200">
                        [{session.range.A.toLocaleString()}, {session.range.B.toLocaleString()}]
                      </span>
                    </div>
                    <div className="flex items-center gap-2 text-xs text-slate-600">
                      <span className="font-bold text-slate-400 uppercase tracking-wider text-[10px]">Width</span>
                      <span className="font-mono bg-white px-2 py-0.5 rounded border border-slate-200">
                        {rangeWidth.toLocaleString()}
                      </span>
                    </div>
                  </div>
                </section>
              )}

              {/* Cards Grid */}
              <section className="space-y-4 mb-8">
                
                {/* 1. Theoretical (OS) */}
                <div className={`academic-card rounded-xl p-5 ${osActive}`}>
                  <div className="flex items-center justify-between mb-3 border-b border-gray-100 pb-2">
                    <div className="flex items-center gap-2">
                      <span className="text-xs font-bold text-teal-800 bg-teal-50 px-2 py-1 rounded">I. 理論値 (OS)</span>
                      {/* Safety Badge */}
                      <span className={`text-[9px] px-1.5 py-0.5 rounded border font-semibold tracking-tight ${badgeStyle}`}>
                        {badgeText}
                      </span>
                    </div>
                    <span className="text-[10px] text-slate-400">Ledger & Approx</span>
                  </div>
                  
                  <div className="flex flex-col gap-2">
                     <div className="flex justify-between items-end">
                        <div className="text-xs text-slate-500 leading-tight">
                           {session.osInLedger ? (
                             <span>証明台帳値<br/><span className="text-[10px] text-slate-400">(Finite Ledger)</span></span>
                           ) : (
                             <span>推計値<br/><span className="text-[10px] text-slate-400">(Estimated)</span></span>
                           )}
                        </div>
                        {/* メイン数値表示：台帳内ならExact、外ならApprox、nullチェックで0も表示 */}
                        <div className={`text-2xl font-mono font-medium ${session.osInLedger ? 'text-teal-800' : 'text-slate-700'}`}>
                           {mainOsValue != null ? mainOsValue.toLocaleString() : "—"}
                        </div>
                     </div>
                     
                     <div className="mt-2 pt-2 border-t border-dashed border-gray-200 text-right">
                       <div className="text-[10px] text-slate-400 font-mono">
                         {/* osApprox might be 0, so check strict nullity */}
                         {session.osApprox != null ? `理論推計: ${session.osApprox.toLocaleString()} ± ${(session.osUpper - session.osApprox).toLocaleString()}` : "—"}
                       </div>
                       {session.osLower != null && session.osUpper != null && (
                         <div className="text-[10px] text-teal-600 font-medium">
                            安全帯: [{session.osLower.toLocaleString()} - {session.osUpper.toLocaleString()}]
                         </div>
                       )}
                     </div>
                  </div>

                  {/* 推計モード時の注釈 */}
                  {!session.osInLedger && hasRange && (
                    <div className="mt-3 pt-2 border-t border-slate-100 text-[10px] text-slate-400 leading-snug">
                      ※ この区間は Ledger 外のため、OS は<span className="text-amber-600 font-medium">「推計値＋安全帯」</span>のみを提示します（完全な証明値ではありません）。
                    </div>
                  )}
                  
                  {hasRange && isTripleMatch && (
                      <div className="mt-3 text-[11px] text-teal-700 bg-teal-50/50 p-2 rounded flex items-center gap-2 animate-fade-in">
                        <span className="font-bold text-lg leading-none">✓</span>
                        <span>{session.osInLedger ? "台帳と実測が一致" : "安全帯内で検証完了"}</span>
                      </div>
                  )}
                </div>

                {/* 2. Geometric (Chamber) */}
                <div className={`academic-card rounded-xl p-5 ${geomActive}`}>
                  <div className="flex items-center justify-between mb-3 border-b border-gray-100 pb-2">
                    <span className="text-xs font-bold text-slate-600 bg-slate-100 px-2 py-1 rounded">II. 幾何構造</span>
                    <span className="text-[10px] text-slate-400">Cell / Chamber</span>
                  </div>
                  
                  <div className="flex items-start gap-4">
                    <div className="flex-none w-20 grid grid-cols-3 gap-px bg-gray-200 border border-gray-200 rounded overflow-hidden">
                      {[0,1,2,3,4,5].map((idx) => {
                        return (
                          <div 
                            key={idx}
                            className={`h-6 flex items-center justify-center text-[8px] font-mono ${
                              session.chamberId && session.chamberId.includes(`_{${idx}}`)
                                ? 'bg-slate-800 text-white' 
                                : 'bg-white text-slate-300'
                            }`}
                          >
                            {idx+1}
                          </div>
                        );
                      })}
                    </div>

                    <div className="flex-1 space-y-1 font-mono text-xs border-l border-gray-100 pl-4">
                       <div className="flex justify-between">
                         <span className="text-slate-400">Type</span>
                         <span className="text-slate-700 font-medium text-[10px]">{session.chamberLabel || "—"}</span>
                       </div>
                       <div className="flex justify-between">
                         <span className="text-slate-400">ID</span>
                         <span className="text-slate-700">{session.chamberId || "—"}</span>
                       </div>
                    </div>
                  </div>
                  
                  {session.osInLedger && session.osExact != null && (
                     <div className="mt-3 text-right animate-fade-in">
                        <div className="text-[10px] text-slate-400 uppercase font-bold tracking-widest mb-0.5">Geometric N</div>
                        <div className="text-2xl font-mono font-medium text-slate-700">
                          {session.osExact.toLocaleString()}
                        </div>
                     </div>
                  )}
                </div>

                {/* 3. Empirical (Counter) */}
                <div className={`academic-card rounded-xl p-5 ${bruteActive}`}>
                  <div className="flex items-center justify-between mb-3 border-b border-gray-100 pb-2">
                    <div className="flex items-center gap-2">
                      <span className="text-xs font-bold text-red-800 bg-red-50 px-2 py-1 rounded">III. 実測値</span>
                      {session.mode === 'os_geom_only' && (
                        <span className="text-[9px] px-1.5 py-0.5 rounded border bg-slate-100 text-slate-500 border-slate-200">
                          Auto-Off
                        </span>
                      )}
                    </div>
                    <span className="text-[10px] text-slate-400">Direct Count</span>
                  </div>
                  
                  {/* Counter Display with Skip State Handling */}
                  {session.mode === 'os_geom_only' ? (
                    <div className="flex flex-col items-center justify-center py-4 text-slate-400 border border-dashed border-slate-200 rounded-lg bg-slate-50">
                      <span className="text-lg">⏸</span>
                      <div className="text-[10px] mt-1 font-medium text-slate-500">
                        区間幅 (B−A) = <span className="font-mono">{rangeWidth?.toLocaleString()}</span> が<br/>
                        上限 <span className="font-mono">{MAX_WIDTH_FOR_BRUTE.toLocaleString()}</span> を超えているためスキップ
                      </div>
                    </div>
                  ) : (
                    <>
                      <div className="mb-4">
                         <div className="flex justify-between items-end mb-1">
                            <div className="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Actual Count</div>
                            <div className="text-3xl font-mono font-medium text-red-900 leading-none">
                              {session.bruteCount != null ? session.bruteCount.toLocaleString() : "—"}
                            </div>
                         </div>
                      </div>
                      
                      {/* Progress Bar */}
                      <div>
                        <div className="flex justify-between text-[10px] text-slate-400 mb-1">
                          <span>進捗 {progressPercent}%</span>
                          {session.mode === 'done' && <span className="text-red-700 font-bold">完了</span>}
                        </div>
                        <div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden">
                          <div 
                            className="h-full bg-slate-800 transition-all duration-300 ease-out" 
                            style={{ width: `${progressPercent}%` }}
                          />
                        </div>
                      </div>
                    </>
                  )}
                </div>

              </section>

              {/* Consistency Result */}
              {isTripleMatch && (
                <section className="mt-8 animate-fade-in pb-8">
                  <div className="bg-slate-900 rounded-2xl shadow-lg p-6 text-center text-white relative overflow-hidden">
                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-teal-500 via-slate-500 to-red-500"></div>
                    
                    <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">
                      Verification Result
                    </h3>
                    
                    <div className="flex flex-col gap-3 items-center justify-center font-serif">
                      <div className="text-2xl md:text-3xl font-bold text-white">
                        {session.osInLedger ? "完全一致 (Exact Match)" : "安全圏内 (Within Range)"}
                      </div>
                      
                      <div className="flex items-center gap-2 text-sm text-slate-300 bg-slate-800/50 px-4 py-2 rounded-lg border border-slate-700 mt-2">
                         <span className="math-font text-teal-300">
                            {session.range ? `π(${session.range.A}, ${session.range.B})` : 'π(A, B)'}
                         </span>
                         <span>=</span>
                         <span className="font-mono font-bold text-xl text-white">{session.bruteCount}</span>
                      </div>
                    </div>
                    
                    <p className="mt-4 text-xs text-slate-400 max-w-lg mx-auto">
                      OS（Finite Ledger / Approx）と幾何構造による分類が、
                      独立した実測カウンタの結果と矛盾なく一致しました。
                    </p>
                  </div>
                </section>
              )}

              {/* Technical Footnote (Accordion) */}
              <div className="mt-8 border-t border-gray-200 pt-6">
                <button 
                  onClick={() => setShowDetails(!showDetails)}
                  className="w-full text-left text-xs font-bold text-slate-500 hover:text-slate-800 flex items-center justify-between p-2 rounded hover:bg-slate-100 transition-colors"
                >
                  <span>付録：詳細なモデル構造について</span>
                  <span className={`transform transition-transform ${showDetails ? 'rotate-180' : ''}`}>▼</span>
                </button>
                
                {showDetails && (
                  <div className="mt-2 text-[11px] text-slate-500 leading-relaxed bg-white p-4 rounded-xl border border-gray-100 shadow-sm animate-fade-in">
                    <div className="space-y-4">
                      <div>
                        <h4 className="font-bold text-teal-700 mb-1">1. 理論 (OS: Ledger & Approx)</h4>
                        <p className="mb-1">
                          OS側の「台帳値」は、事前に固定された有限表 <code>{"PRIME_PI_LEDGER"}</code> からのみ読み出されています。
                          台帳にない区間については、素数定理に基づく近似値と安全帯のみを提示します。
                        </p>
                      </div>
                      <div>
                        <h4 className="font-bold text-red-700 mb-1">2. 実測 (Counter)</h4>
                        <p>
                          画面下部の素数カウンタは、独立に <code>{"isPrime"}</code> を用いた実測カウントを行っており、OSとはアルゴリズム上も責任範囲上も完全に分離されたモジュールです。
                        </p>
                      </div>
                    </div>
                  </div>
                )}
              </div>
              
              <footer className="mt-8 text-[10px] text-slate-400 text-center max-w-md mx-auto leading-relaxed pb-8">
                <p>
                  このデモは、有限台帳・Chamber構造・実測カウントが矛盾なく噛み合う Finite Closure 型の構造を可視化したものです。
                </p>
              </footer>

            </main>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
